@model List<DataLayer.DTO.ProviderDTO.ProviderRequestData>

@functions {
    public string GetColor(int RequestTypeId)
    {
        switch (RequestTypeId)
        {
            case 1: return "pink";
            case 2: return "green";
            case 3: return "orange";
            case 4: return "blue";
            default: return "green";
        }
    }
}

 @if (Model.Count > 0)
{
    var type = Model[0].status;

    <div class="table-responsive d-none d-lg-block">

        <table class="table" id="adminTable" data-count=@ViewBag.Count>
            <thead>
                <tr>
                    <th scope="col">Name </th>


                    <th scope="col">Phone</th>


                    <th scope="col">Address</th>
                    @if (type == 3)
                    {
                        <th scope="col">Status</th>

                    }

                    <th scope="col">Actions</th>

                </tr>
            </thead>
            @foreach (var obj in Model)
            {
                <tbody>

                    <tr class=" requestTable align-middle table-@{
                                                                @GetColor(obj.RequestTypeId)
 }">

                        <td scope="row" class="text-white">
                            <div class="d-inline-flex w-100">
                                <div class="w-100">
                                    @obj.Name
                                </div>
                                <div style="border:1px white solid " class="rounded">
                                    <button class="btn text-white">
                                        <i class="fa-regular fa-envelope"></i>
                                    </button>
                                </div>
                            </div>
                        </td>



                        <td class="text-white text-nowrap">
                            <span class="border border-white rounded p-2  "><i class="bi bi-telephone p-2"></i>@obj.PhoneP</span>
                        </td>
                        <td class="text-white">
                            <span class=" text-nowrap d-block  ">@obj.Address</span>
                        </td>
                        @if (type == 3)
                        {
                            @if (obj.typeofcare == 5)
                            {
                                <td class="text-white">
                                    <button class="btn btn-info text-white" onclick="HouseCallBtn(@obj.RequestId)">House Call</button>

                                </td>
                            }
                            else
                            {
                                <td class="text-white"></td>
                            }

                }
                        <td class="text-white">

                            <button class="btn text-white border border-white" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                Action
                            </button>
                            <ul class="dropdown-menu">
                                @if (type == 1)
                                {
                                    <li class="">
                                        <button class="btn  dropdown-item " onclick="AcceptReq(@obj.RequestId)">
                                            <i class="fa-regular fa-file-lines me-2 ms-1"></i>  Accept
                                        </button>
                                    </li>

                                }
                                @if (type == 4)
                                {
                                    <li class="">
                                        <a class="btn  dropdown-item" asp-action="ConcludeCare" asp-controller="Provider" asp-route-reqId="@obj.RequestId">
                                            <i class="fa-solid fa-heart-pulse me-2 ms-1"></i>  Conclude care
                                        </a>
                                    </li>

                                }

                                @if (type == 2)
                                {
                                    <li class="">
                                        <button class="btn  dropdown-item send-agreement"
                                                data-toggle="modal" data-target="#model6"
                                                data-argreqid="@obj.RequestId"
                                                data-reqtype="@obj.RequestTypeId"
                                                data-phone="@obj.PhoneP"
                                                data-email="@obj.Email">
                                            <i class="fa-solid fa-file-import  me-2 ms-1"></i>   Send Agreement
                                        </button>
                                    </li>

                                }
                                <li class="">
                                    <a class="btn  dropdown-item" asp-action="ViewCase" asp-controller="Admin" asp-route-reqId="@obj.RequestId">
                                        <i class="fa-solid fa-file-signature  me-2 ms-1"></i>  View case
                                    </a>
                                </li>


                                @if (type != 1)
                                {
                                    <li class="">
                                        <a asp-action="ViewUploads" asp-controller="Admin" asp-route-viewid="@obj.RequestId" class="btn  dropdown-item" >
                                            <i class="fa-solid fa-file-arrow-up  me-2 ms-1"></i>   View Uploads
                                        </a>
                                    </li>

                                }
                                <li class="">
                                    <a class="btn  dropdown-item" asp-action="ViewNotes" asp-controller="Admin" asp-route-Requestid="@obj.RequestId">
                                        <i class="fa-solid fa-book  me-2 ms-1"></i>  View notes
                                    </a>
                                </li>


                                @if (type == 2)
                                {
                                    <li class="">
                                        <button class="btn  dropdown-item trasfercasemodel"
                                                data-toggle="modal" data-target="#transfermodal"
                                        data-transid="@obj.RequestId">
                                            <i class="fa-regular fa-file-lines me-2 ms-1"></i>  Transfer
                                        </button>
                                    </li>

                                }
                                @if (type == 3)
                                {
                                    <li class="">
                                        <a class="btn  dropdown-item" asp-controller="Admin" asp-action="AdminOrders" asp-route-ordreqid="@obj.RequestId">
                                            <i class="fa-regular fa-file-lines me-2 ms-1"></i>  Orders
                                        </a>
                                    </li>

                                }
                                @if (type == 3 )
                                {
                                    @if (obj.typeofcare == 5)
                                    {
                                        <li class="">
                                            <button onclick="EnconterBtn(@obj.RequestId)" class="btn  dropdown-item">
                                                <i class="fa-regular fa-file-lines me-2 ms-1"></i>  Encounter
                                            </button>
                                        </li>
                                    }
                                    else
                                    {
                                        <li class="">
                                            <button class="btn  dropdown-item caremodalbtn"
                                                    data-toggle="modal" data-target="#typeofcaremodal"
                                                    data-typecareid="@obj.RequestId">
                                                <i class="fa-regular fa-file-lines me-2 ms-1"></i>  Encounter
                                            </button>
                                        </li>
                                    }


                        } 
                                @if (type == 4)
                                {
                                    <li class="">
                                        <button onclick="EnconterBtn(@obj.RequestId)" class="btn  dropdown-item">
                                            <i class="fa-regular fa-file-lines me-2 ms-1"></i>  Encounter
                                        </button>
                                    </li>

                                }




                            </ul>

                        </td>
                    </tr>

                </tbody>
            }
        </table>

    </div>

    <div class="d-lg-none">
        <br>
        @foreach (var item in Model)
        {
            var acoid = item.RequestId;
            <div class="accordion " id="accordionExample">

                <div class="accordion-item accordian-back ">
                    <h2 class="accordion-header">
                        <button class="accordion-button accordian-back collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#id-@acoid" aria-expanded="false" aria-controls="collapseTwo">
                            <div class="container-fluid">

                                <div class="row">
                                    <div class="col">
                                        <p> @item.Name</p>
                                        <p>@item.Address</p>
                                    </div>
                                    <div class="col ">
                                        <div class="float-end">


                                            @if (item.RequestTypeId == 2)
                                            {
                                                <div class="d-flex justify-content-end">
                                                    <p>Patient </p>
                                                    <div class="border border-1 rounded-5 m-1 " style="width: 15px; height:15px; background-color: #60bc60;"></div>

                                                </div>
                                            }
                                            @if (item.RequestTypeId == 3)
                                            {
                                                <div class="d-flex justify-content-end">
                                                    <p>Family/Friend</p>
                                                    <div class="border border-1 rounded-5 m-1 " style="width: 15px; height:15px; background-color: #ee9125;"></div>


                                                </div>
                                            }@if (item.RequestTypeId == 4)
                                            {
                                                <div class="d-flex justify-content-end">
                                                    <p>Concierge</p>
                                                    <div class="border border-1 rounded-5 m-1 " style="width: 15px; height:15px; background-color: pink;"></div>
                                                </div>
                                            }@if (item.RequestTypeId == 1)
                                            {
                                                <div class="d-flex justify-content-end9">
                                                    <p>Business</p>
                                                    <div class="border border-1 rounded-5 m-1 " style="width: 15px; height:15px; background-color: #007fc7;"></div>


                                                </div>
                                            }

                                            <a class="btn btn-outline-info " style="border-radius:30px">Map Location</a>
                                        </div>
                                    </div>

                                </div>


                                <br>
                            </div>



                        </button>
                    </h2>

                    <div id="id-@acoid" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
                        <div class="d-flex justify-content-end d-inline">
                            <a asp-controller="Admin" asp-route-reqId="@item.RequestId" asp-action="ViewCase"
                               class="rounded-pill me-3 viewCaseBtn px-4 py-2 viewCase fw-bolder text-decoration-none">
                                View Case
                            </a>
                        </div>

                        <div class="accordion-body pt-0">
                            <div>


                                @if (item.status == 1)
                                {
                                    <div class="d-flex align-items-center">
                                        <div style="border: 2px solid; border-radius:1000px; width:33px; height:33px"
                                             class="border-info d-flex justify-content-center me-2">
                                            <i class="bi bi-envelope"></i>
                                        </div>
                                        <p><span class="text-muted">Date Of Birth:</span>  @item.Dob</p>

                                    </div>
                                }

                                <div class="d-flex align-items-center">
                                    <div style="border: 2px solid; border-radius:1000px; width:33px; height:33px"
                                         class="border-info d-flex justify-content-center me-2">
                                        <i class="bi bi-envelope"></i>
                                    </div>
                                    <p><span class="text-muted">Email:</span>  @item.Email</p>

                                </div>
                                @if (item.status == 2)
                                {
                                    <div class="d-flex align-items-center">
                                        <div style="border: 2px solid; border-radius:1000px; width:33px; height:33px"
                                             class="border-info d-flex justify-content-center me-2">
                                            <i class="bi bi-person"></i>
                                        </div>
                                        <p><span class="text-muted">Address:</span> @item.Address</p>
                                    </div>
                                }
                                <div class="d-flex align-items-center">
                                    <div style="border: 2px solid; border-radius:1000px; width:33px; height:33px"
                                         class="border-info d-flex justify-content-center me-2">
                                        <i class="bi bi-telephone"></i>
                                    </div>
                                    <p><span class="text-muted">Patient:</span> @item.PhoneP</p>
                                </div>

                            </div>


                            @* BUTTONS *@



                            <div class="row">
                                @if (item.status == 4)
                                {
                                    <div class="col-6 p-2">

                                        <a style="border-radius:30px; "
                                           asp-action="ConcludeCare" asp-controller="Provider" asp-route-reqId="@item.RequestId"
                                                class="btn btn-danger  text-white w-100 p-2 ">
                                            Conclude Care
                                        </a>

                                    </div>
                                }
                                @if (item.status == 1)
                                {
                                    <div class="col-6 p-2">
                                        <button style="border-radius:30px; background-color:#5E1675;"
                                                class="btn text-white w-100 p-2 "
                                                onclick="AcceptReq(@item.RequestId)">
                                            Accept
                                        </button>
                                    </div>

                                }
                                @if (item.status == 2)
                                {
                                    <div class="col-6 p-2">
                                        <button style="border-radius:30px; background-color:#ee9125;"
                                                class="btn text-white w-100 p-2 send-agreement"
                                                data-toggle="modal" data-target="#model6"
                                                data-argreqid="@item.RequestId"
                                                data-reqtype="@item.RequestTypeId"
                                                data-phone="@item.PhoneP"
                                                data-email="@item.Email">
                                            Send Agreement
                                        </button>
                                    </div>

                                }
                                <div class="col-6 p-2">
                                    <a class="text-decoration-none" asp-controller="Admin" asp-route-Requestid="@item.RequestId" asp-action="ViewNotes">
                                        <button style="border-radius:30px; "
                                                class="btn btn-success text-white w-100 p-2 ">
                                            View Notes
                                        </button>
                                    </a>
                                </div>

                                @if (item.status == 2 || item.status == 3 || item.status == 4)
                                {
                                    <div class="col-6 p-2">
                                        <a class="text-decoration-none" asp-controller="Admin" asp-action="ViewUploads" asp-route-viewid="@item.RequestId">
                                            <button style="border-radius:30px; "
                                                    class="btn btn-success text-white w-100 p-2 ">
                                                View Uploads
                                            </button>
                                        </a>
                                    </div>
                                }
                                @if (item.status == 3)
                                {
                                    @if (item.typeofcare == 5)
                                    {
                                        <div class="col-6 p-2">
                                            <button style="border-radius:30px; " onclick="EnconterBtn(@item.RequestId)" class="btn btn-success text-white  w-100 p-2 ">
                                                Encounter
                                            </button>
                                            </div>
                                       
                                       
                                    }
                                    else
                                    {
                                        <div class="col-6 p-2">
                                            <button style="border-radius:30px; " class="btn  caremodalbtn btn-success text-white  w-100 p-2 "
                                                    data-toggle="modal" data-target="#typeofcaremodal"
                                                    data-typecareid="@item.RequestId">
                                                Encounter
                                            </button>
                                            </div>
                                       
                                  
                                    }
                                } 
                                @if ( item.status == 4)
                                {
                                    <div class="col-6 p-2">
                                        <a class="text-decoration-none" asp-controller="Admin" asp-action="Encounter" asp-route-encreqid="@item.RequestId">
                                            <button style="border-radius:30px; "
                                                    class="btn btn-success text-white w-100 p-2 ">
                                                Encounter
                                            </button>
                                        </a>
                                    </div>
                                }
                                @if (item.status == 3)
                                {
                                    <div class="col-6 p-2">
                                        <a class="text-decoration-none" asp-controller="Admin" asp-action="AdminOrders" asp-route-ordreqid="@item.RequestId">
                                            <button style="border-radius:30px; background-color:#ee9125;"
                                                    class="btn text-white w-100 p-2 ">
                                                Orders
                                            </button>
                                        </a>
                                    </div>

                                }


                                @if (item.status == 3)
                                {
                                    @if (item.typeofcare == 5)
                                    {
                                        <div class="col-6 p-2">
                                            <button style="border-radius:30px;" class="btn btn-info text-white  w-100 p-2" onclick="HouseCallBtn(@item.RequestId)">House Call</button>

                                           </div>                                    
                                    }
                                   
                                    

                                }
                                <div class="col-6 p-2">
                                    <a style="border-radius:30px; " class="btn btn-success text-white w-100 p-2 ">
                                        Email
                                    </a>
                                </div>

                            </div>

                            <div class="d-inline-flex justify-content-end align-items-center w-100">
                                <p class="m-2">Chat with: </p>

                                @if (item.status != 1)
                                {
                                    <button class="btn btn-outline-info m-2">Patient</button>

                                }
                                <button class="btn btn-outline-info m-2">Admin</button>





                            </div>

                        </div>
                    </div>
                </div>


            </div>
        }
        <br>

    </div>

    <div id="pagination" class="d-flex flex-row-reverse p-3">
        <div class="d-flex">
            <button class=" btn btn-light prev-button" disabled><i class="fa-solid fa-arrow-rotate-left"></i> </button>
            <!-- Pagination buttons container -->
            <div class="page-buttons"></div>
            <button class="btn  btn-light  next-button"> <i class="fa-solid fa-arrow-rotate-right"></i> </button>
        </div>
    </div>
}
else
{
    <p class="a-table">No data found</p>
}
<!-- Send Agreement Modal -->
<div class="modal fade" id="model6" tabindex="-1" role="dialog" aria-labelledby="model6" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">

        <div class="modal-content">
            <div style="background-color:#0dcaf0; color:white;" class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle"> Send Agreement</h5>
                <button type="button" class="close btn btn-lg text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form class="Agreementform">
                <div class="modal-body">
                    <div id="requesttypetext" class="d-inline-flex">
                    </div>
                    <p>To transfer this request, search and select another physician.</p>
                    <input type="number"
                           hidden
                           name="arg_req_id"
                           id="argreqid" />
                    <div>
                        <div class=" mb-3">
                            <input type="text"
                                   name="argPhone"
                                   class="form-control"
                                   id="argPhone"
                                   placeholder="Phone Number" required />
                        </div>

                    </div>

                    <div class=" mb-3">
                        <input type="text"
                               class="form-control"
                               name="argEmail"
                               id="argEmail"
                               placeholder="Email" required />
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button id="sendAgrsubmit" type="button" class="btn btn-info text-white">Send</button>
                    <button class="btn btn-outline-info " data-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>

    </div>
</div>



<!-- Transfer case  Modal -->
<div class="modal fade" id="transfermodal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div style="background-color:#0dcaf0; color:white;" class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Transfer Request</h5>
                <button type="button" class="close btn btn-lg text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form class="transfercase">
                <div class="modal-body">
                    <input type="number"
                           hidden
                           name="transferid"
                           id="transferid" />
                    <p>This request will be transferred to admin.</p>
                        <textarea class="form-control"
                                  placeholder="Description"
                                  id="floatingTextarea"
                                  name="tranfernote"
                                  style="height: 100px" required></textarea>
                </div>
                <div class="modal-footer border-0">

                    <button id="tranfersubmit"  type="button" class="btn text-white btn-info ">Submit</button>
                    <button  type="button" class="btn btn-outline-info " data-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Type of care Modal -->
<div class="modal fade" id="typeofcaremodal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div style="background-color:#0dcaf0; color:white;" class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Select Type Of Care</h5>
                <button type="button" class="close btn btn-lg text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form class="typeofcare">
                <div class="modal-body pb-0 d-flex justify-content-center">
                    <input type="number"
                           hidden
                           name="careid"
                           id="careid" />

                    <div class="form-check btn btn-outline-info m-2">
                        <input class="form-check-input" type="radio" name="selecttype" value="1" id="housecall" hidden checked>
                        <label class="form-check-label" for="housecall">
                            Housecall
                        </label>
                    </div>
                    <div class="form-check btn btn-outline-info m-2">
                        <input class="form-check-input" type="radio" name="selecttype" value="2" id="consult" hidden>
                        <label class="form-check-label" for="consult">
                           Consult
                        </label>
                    </div>
                  
                </div>
                <div class="modal-footer border-0">

                    <button id="typeofcaresave"  type="button" class="btn btn-info text-white">Save</button>


                    <button type="button" class="btn btn-outline-info" data-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Download encounter Modal -->
<div class="modal fade" id="EncounterModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div style="background-color:#0dcaf0; color:white;" class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Encounter Form </h5>
                <button type="button" class="close btn btn-lg text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form class="">
                <div class="modal-body pb-0 d-flex justify-content-center">
                    <input type="number"
                           hidden
                           name="encid"
                           id="encid" />

                  
                <p>Encounter form is finalized successfully !</p>
              
                </div>
                <div class="d-flex justify-content-center m-2">
                    <button class="btn btn-info text-white" id="btnGeneratePDF" type="button">Download</button>
                    
                </div>
                <br />
            </form>
        </div>
    </div>
</div>

<script>
    $("#sendAgrsubmit").on('click', function () {
        if ($('.Agreementform').valid()){
            $.ajax({
                method: "POST",
                url: '@Url.Action("SendAgreement", "Admin")',
                data: $('form.Agreementform').serialize(),
                success: function (result) {
                    toastr.success('Agreement sent successfully');
                    setTimeout(function () {
                        window.location.reload();
                    }, 3000);

                }

            });
        }
       
    });

     $("#tranfersubmit").on('click', function () {
         if($('.transfercase').valid()){
            $.ajax({
                method: "POST",
                url: '@Url.Action("TranferReqAdmin", "Provider")',
                data: $('form.transfercase').serialize(),
                success: function (result) {
                    toastr.success('Request transfered to admin');
                    setTimeout(function () {
                        window.location.reload();
                    }, 3000);

                }

            });
         }
        
    });  
    
    $("#typeofcaresave").on('click', function () {
        $.ajax({
            method: "POST",
            url: '@Url.Action("SelectTypeOfCare", "Provider")',
            data: $('form.typeofcare').serialize(),
            success: function (result) {
                toastr.success('Type of care is set');
                setTimeout(function () {
                    window.location.reload();
                }, 3000);


            }

        });
    });

    function HouseCallBtn(reqid) {
        $.ajax({
            method: "POST",
            url: '@Url.Action("HousCallClick", "Provider")',
            data: { reqid: reqid },
            success: function (result) {
                toastr.success('Request concluded');
                setTimeout(function () {
                    window.location.reload();
                }, 3000);


            }

        });
    }

    function EnconterBtn(reqid){
        var myModal = new bootstrap.Modal(document.getElementById('EncounterModal'), {})

        $.ajax({
            method: "POST",
            url: '@Url.Action("IsEncounterFinalized", "Provider")',
            data: { reqid: reqid },
            success: function (result) {

              if(result){
                  $('#encid').val(reqid)
                    myModal.show()
              }else{

                    window.location.href = "/Provider/EncounterProvider?encreqid=" + reqid

              }
            }

        });
    }

    
    $("#btnGeneratePDF").click(function () {
        var requestId = $('#encid').val();
        window.location.href = "/Provider/GeneratePDF?requestId=" + requestId;
    })
</script>